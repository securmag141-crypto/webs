<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Звонок t1001/t1002</title>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    button { padding: 12px 24px; margin: 10px; font-size: 18px; }
    .id { background: #eee; padding: 8px; margin: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="id">Ваш ID: <span id="myId">—</span></div>
  <div class="id">Звонить: <span id="targetId">—</span></div>
  <button onclick="startCall()">Позвонить</button>
  <button onclick="hangUp()">Сбросить</button>
  <audio id="remoteAudio" autoplay playsinline></audio>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    // === НАСТРОЙКА: МЕНЯЙТЕ ЭТО ЗНАЧЕНИЕ НА КАЖДОМ УСТРОЙСТВЕ ===
    const MY_ID = 't1001'; // ← на другом устройстве поставьте 't1002'

    const TARGET_ID = MY_ID === 't1001' ? 't1002' : 't1001';

    document.getElementById('myId').textContent = MY_ID;
    document.getElementById('targetId').textContent = TARGET_ID;

    const peer = new Peer(MY_ID, {
      host: 'my-peerserver.onrender.com', // ← замените на ваш Render URL
      port: 443,
      path: '/myapp',
      secure: true
    });

    let currentCall = null;
    let localStream = null;

    peer.on('error', err => {
      console.error(err);
      alert('Ошибка: ' + err.message);
    });

    peer.on('call', call => {
      if (!localStream) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            localStream = stream;
            call.answer(stream);
            call.on('stream', remoteStream => {
              remoteAudio.srcObject = remoteStream;
            });
          })
          .catch(err => alert('Микрофон: ' + err.message));
      } else {
        call.answer(localStream);
        call.on('stream', remoteStream => {
          remoteAudio.srcObject = remoteStream;
        });
      }
    });

    function startCall() {
      if (!localStream) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            localStream = stream;
            currentCall = peer.call(TARGET_ID, stream);
            currentCall.on('stream', remoteStream => {
              remoteAudio.srcObject = remoteStream;
            });
          })
          .catch(err => alert('Микрофон: ' + err.message));
      } else {
        currentCall = peer.call(TARGET_ID, localStream);
        currentCall.on('stream', remoteStream => {
          remoteAudio.srcObject = remoteStream;
        });
      }
    }

    function hangUp() {
      if (currentCall) {
        currentCall.close();
        currentCall = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
      }
      remoteAudio.srcObject = null;
    }
  </script>
</body>
</html>